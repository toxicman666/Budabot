<?phpif (preg_match("/^raidhistory$/i", $message)) {	$db = DB::get_instance();	$db->query("SELECT * FROM tara_raid_history t LEFT JOIN tara_raids r ON t.type=r.short_name ORDER BY time DESC LIMIT 20;");	if ($db->numrows()===0){		$chatBot->send("No raid history yet.",$sendto);		return;	}	$blob = "<header>:::: Last 20 Raids ::::<end>\n\n";	while($row=$db->fObject()){		$blob .= "<yellow>:" . gmdate('j/M/y G:i',$row->time) . ": <end>{$row->long_name} ({$row->short_name}) by {$row->leader} " . Text::make_link("more info", "/tell <myname> !raidhistory {$row->id}",'chatcmd') . "\n\n";	}	$msg = Text::make_link("Last 20 raids",$blob,'blob');	$chatBot->send($msg,$sendto);} else if (preg_match("/^raidhistory ([0-9]+)$/i", $message, $arr)) {	$raid_id = intval($arr[1]);	$db = DB::get_instance();	$db->query("SELECT * FROM tara_raid_history t LEFT JOIN tara_raids r ON t.type=r.short_name WHERE t.id={$raid_id};");	if ($db->numrows()===0){		$chatBot->send("Invalid raid id",$sendto);		return;	}	$raidrow=$db->fObject();	$timestr=gmdate('j/M/y G:i',$raidrow->time);	$blob = "<header>:: {$raidrow->long_name} ::<end>";	$blob .= "\nby <yellow>{$raidrow->leader}<end>";	$blob .= "\n<highlight>Date:<end> {$timestr}\n";	$db->query("SELECT * FROM tara_points_history t LEFT JOIN tara_loot l ON t.item=l.short_name WHERE raid_id={$raid_id} AND item!='' ORDER BY t.id ASC;");	if ($db->numrows()>0){		$blob .= "\n<highlight>::Items won:<end>\n";		while ($row=$db->fObject()){			if ($row->name!=""){				$points = 0-intval($row->change);				if ($row->refunded!="") $refunded = " <orange>[refunded by {$row->refunded}]<end>";				else $refunded = "";				$blob .= "<white>{$row->name}<end> won <white>{$row->long_name}<end> for {$points} points{$refunded}\n";			} else {				$blob .= "<white>{$row->long_name}<end> deleted (No bidders)\n";			}		}	}	$db->query("SELECT * FROM tara_points_history WHERE raid_id={$raid_id} AND item='' ORDER BY name;");	if ($db->numrows()>0){		$blob .= "\n<highlight>::Points awarded: " . $db->numrows() . " players<end>\n";		while ($row=$db->fObject()){			$blob .= "{$row->name} {$row->change}\n";		}	}	$msg = Text::make_link("Info for raid {$raid_id}",$blob,'blob');	$chatBot->send($msg,$sendto);} else if (preg_match("/^raidhistory ([a-z0-9-]+)$/i", $message, $arr)) {	$name=ucfirst(strtolower($arr[1]));	$uid = $chatBot->get_uid($name);	if(!$uid) {		$chatBot->send("Invalid player <highlight>{$arr[1]}<end>",$sendto);		return;	}	$topic = Setting::get("raid_topic");	if ($topic!="" && $name!=$sender){		$chatBot->send("<orange>Raid in progress, try again later.<end>",$sendto);		return;	}/*	if(isset($chatBot->data["TARA_MODULE"]["auction"]) && $name!=$sender){		$chatBot->send("<orange>Auction in progress, try again later.<end>",$sender);		return;	}	*/	$msg = "";	if (isset($chatBot->admins[$sender])){		if ($chatBot->admins[$sender]["level"] >= 3 && $sendto==$sender) {			$msg = Tara::get_points_blob($name,"Raid history for {$name}", true);		}	}	if ($msg == "") $msg = Tara::get_points_blob($name,"Raid history for {$name}");	if ($msg===false) $msg = "No history found for <highlight>{$name}<end>";	if (is_array($msg) && $sendto!=$sender) {		$chatBot->send($msg[1] . " - continued in PM...",$sendto);		unset($msg[1]);		$sendto = $sender;	}	$chatBot->send($msg,$sendto);} else {	$syntax_error = true;}?>